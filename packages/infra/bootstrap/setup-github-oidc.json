{
  "Parameters": {
    "GitHubOrg": {
      "Description": "Name of GitHub organization/user (case sensitive)",
      "Type": "String",
      "Default": "chetzof"
    },
    "RepositoryName": {
      "Description": "Name of GitHub repository (case sensitive)",
      "Type": "String",
      "Default": "personal-blog"
    },
    "OIDCProviderArn": {
      "Description": "Arn for the GitHub OIDC Provider.",
      "Default": "",
      "Type": "String"
    },
    "OIDCAudience": {
      "Description": "Audience supplied to configure-aws-credentials.",
      "Default": "sts.amazonaws.com",
      "Type": "String"
    }
  },
  "Conditions": {
    "CreateOIDCProvider": {
      "Fn::Equals": [
        {
          "Ref": "OIDCProviderArn"
        },
        ""
      ]
    }
  },
  "Resources": {
    "Role": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "GithubOidcRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Principal": {
                "Federated": {
                  "Fn::If": [
                    "CreateOIDCProvider",
                    {
                      "Ref": "GithubOidc"
                    },
                    {
                      "Ref": "OIDCProviderArn"
                    }
                  ]
                }
              },
              "Condition": {
                "StringEquals": {
                  "token.actions.githubusercontent.com:aud": {
                    "Ref": "OIDCAudience"
                  }
                },
                "StringLike": {
                  "token.actions.githubusercontent.com:sub": {
                    "Fn::Sub": "repo:${GitHubOrg}/${RepositoryName}:*"
                  }
                }
              }
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CDKRoles",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": {
                "Effect": "Allow",
                "Action": "sts:AssumeRole",
                "Resource": "arn:aws:iam::799200882264:role/cdk-hnb659fds*"
              }
            }          }
        ]
      }
    },
    "GithubOidc": {
      "Type": "AWS::IAM::OIDCProvider",
      "Condition": "CreateOIDCProvider",
      "Properties": {
        "Url": "https://token.actions.githubusercontent.com",
        "ClientIdList": [
          "sts.amazonaws.com"
        ],
        "ThumbprintList": [
          "6938fd4d98bab03faadb97b34396831e3780aea1"
        ]
      }
    }
  },
  "Outputs": {
    "Role": {
      "Value": {
        "Fn::GetAtt": [
          "Role",
          "Arn"
        ]
      }
    }
  }
}